# S05 – Матрица вариантов (Option Matrix)

## 0) Контекст риска (из S04)

* **Risk-ID:** R-01    **Threat:** S (Spoofing)
* **DFD element/edge:** Internet → API
* **NFR link (ID):** NFR-002, NFR-003
* **L×I (1–5):** L=4, I=5, **Score=20**
* **Ограничения/предпосылки:** публичный интерфейс, stateless JWT-аутентификация; без сессий; строгие SLA по latency; использование стандартного Auth Gateway без state store.

---

## 1) Критерии и шкалы (1–5)

**Польза (↑):** Security impact, Blast radius reduction
**Стоимость/сложность (↓):** Complexity, Time-to-mitigate, Dependencies

---

## 2) Таблица сравнения вариантов

| Alternative | Summary                                                             | Security impact (↑,1–5) | Blast radius reduction (↑,1–5) | Complexity (↓,1–5) | Time-to-mitigate (↓,1–5) | Dependencies (↓,1–5) | **Benefit** | **Cost** | **Net** | Notes                                                                           |
| ----------- | ------------------------------------------------------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | ------------------------------------------------------------------------------- |
| **A**       | JWT с коротким TTL (≤15 мин), refresh-токен, проверка `iss/aud/exp` |                       4 |                              3 |                  2 |                        2 |                    2 |       **7** |    **6** |  **+1** | Быстро внедряется, минимум зависимостей; подходит под stateless-арх.            |
| **B**       | mTLS клиент↔сервер для аутентификации                               |                       5 |                              4 |                  4 |                        4 |                    5 |       **9** |   **13** |  **−4** | Высокая защита, но требует PKI, управление сертификатами и обновления клиентов. |
| **C**       | Session store (stateful JWT revocation / blacklist)                 |                       4 |                              4 |                  3 |                        3 |                    4 |       **8** |   **10** |  **−2** | Улучшает контроль за токенами, но усложняет масштабирование и хранение.         |

---

## 3) Тай-брейкеры при равенстве Net

* **Compliance/Privacy:** JWT TTL соответствует требованиям сессий и GDPR-retention.
* **Maintainability:** JWT TTL + Refresh проще поддерживать, не требует отдельного сервера.
* **Team fit:** команда уже применяет JWT; PKI-экспертизы нет.
* **Observability:** можно логировать refresh-потоки и токены с `jti`.
* **Rollback safety:** смена TTL обратима через конфигурацию без релиза.

---

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** **A**
* **Почему:** Быстрее внедряется, даёт высокое снижение риска без значительного усложнения архитектуры. Не требует инфраструктуры PKI или состояния.
* **ADR candidate (название):** “JWT TTL + Refresh Token Rotation”
* **Связки:** Risk-ID R-01, NFR-002/003, DFD: Internet → API
* **Следующие шаги:**

  1. Настроить JWT TTL = 15 мин и refresh TTL = 24 ч
  2. Проверять `aud`, `iss`, `exp` в middleware
  3. Добавить refresh-эндпоинт `/api/auth/refresh`
  4. Ротировать signing key каждые 7 дней
  5. Обновить e2e-тесты и логи (корреляция `jti`)

---

## 5) Самопроверка

* [x] Указан риск и контекст из S04 (Risk-ID, DFD, NFR-ID, L×I)
* [x] Сравнены минимум 2 альтернативы (3 включено)
* [x] Заполнены все критерии, рассчитаны Benefit/Cost/Net
* [x] Прописаны тай-брейкеры
* [x] Принято решение и ADR-кандидат определён
