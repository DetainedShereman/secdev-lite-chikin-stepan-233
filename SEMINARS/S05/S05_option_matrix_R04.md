# S05 – Матрица вариантов (Option Matrix)

> Рабочее расположение: `SEMINARS/S05/S05_option_matrix_R04.md`
> Риск: *зависание при обращении к внешнему API из-за отсутствия таймаутов, ретраев и circuit breaker.*

---

## 0) Контекст риска (из S04)

* **Risk-ID:** `R-04`    **Threat:** `D – Denial of Service`
* **DFD element/edge:** `Service → External API`
* **NFR link (ID):** `NFR-005`
* **L×I (1–5):** `L=3`, `I=4`, **Score=12**
* **Ограничения/предпосылки:**

  * Node.js / Python backend, HTTP-клиент (`axios` / `httpx`).
  * Не допускается превышение SLA 6 s на внешний вызов.
  * Возможна деградация внешнего API (`vendor-x`).

---

## 1) Критерии и шкалы (1–5)

**Польза (↑):**

* **Security impact (↑):** снижает вероятность отказа/зависания сервиса.
* **Blast radius reduction (↑):** ограничивает воздействие проблемы внешнего API.

**Стоимость/сложность (↓):**

* **Complexity (↓):** реализация и конфигурация.
* **Time-to-mitigate (↓):** сколько нужно спринтов до эффекта.
* **Dependencies (↓):** внешние библиотеки, взаимодействие с другими командами.

---

## 2) Таблица сравнения вариантов

| Alternative | Summary (1–2 фразы)                                                       | Security impact (↑,1–5) | Blast radius reduction (↑,1–5) | Complexity (↓,1–5) | Time-to-mitigate (↓,1–5) | Dependencies (↓,1–5) | **Benefit** | **Cost** | **Net** | Notes                                                    |
| ----------- | ------------------------------------------------------------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | -------------------------------------------------------- |
| **A**       | Ввести **timeout=2 s** + **retry=3** с джиттером                          |                       4 |                              3 |                  2 |                        2 |                    2 |       **7** |    **6** |  **+1** | Простое внедрение; быстро снижает риск, но без fallback. |
| **B**       | Использовать **Circuit Breaker** (например, `resilience4j` / `pybreaker`) |                       5 |                              4 |                  3 |                        3 |                    3 |       **9** |    **9** |   **0** | Требует настройки и метрик; контролирует деградацию.     |
| **C**       | Добавить **asynchronous queue / fallback cache**                          |                       5 |                              5 |                  5 |                        4 |                    4 |      **10** |   **13** |  **−3** | Высокая устойчивость, но сложно и долго внедрять.        |

> **Benefit = Security impact + Blast radius reduction**
> **Cost = Complexity + Time + Dependencies**
> **Net = Benefit − Cost**

---

## 3) Тай-брейкеры при равенстве Net

* **Compliance/Privacy:** не влияет.
* **Maintainability:** A проще поддерживать.
* **Team fit:** у команды есть опыт конфигурации таймаутов/ретраев.
* **Observability:** в B и C требуется больше метрик и алертов.
* **Rollback safety:** A и B безопасны для отката.

---

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** **A – Timeout + Retry (2 s, ≤3, с джиттером)**
* **Почему:** даёт ощутимое снижение риска DoS при минимальной сложности; быстрая реализация, не требует новых зависимостей.
  Circuit Breaker (B) добавляет контроль, но равен по Net и сложнее поддерживать; C слишком трудоёмкий.
* **ADR candidate (название):** `“Timeout + Retry Policy for External API”`
* **Связки:** Risk-ID `R-04`, NFR-ID `NFR-005`, DFD `Service → External API`
* **Следующие шаги:**

  1. Добавить конфигурацию `timeout=2 s`, `retries≤3` с экспоненциальным джиттером.
  2. Обновить клиент `vendor-x` и тесты отказов.
  3. Добавить метрики `request_duration`, `retries_total`, `timeout_errors_total`.
  4. Проверить SLA ≤6 s и записать результаты в evidence.
  5. Подготовить ADR `S05_ADR_timeout_retry.md`.

---

## 5) Самопроверка

* [x] Контекст риска и NFR указаны.
* [x] 3 альтернативы.
* [x] Все критерии 1–5 заполнены.
* [x] Benefit/Cost/Net рассчитаны.
* [x] Выбрано решение и ADR candidate определён.
* [x] Готово к переносу в `S05_ADR_timeout_retry.md`.
