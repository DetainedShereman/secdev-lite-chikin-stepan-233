# S03

| ID      | User Story / Feature                         | Category                      | Requirement (NFR)                                                                                                                                                   | Rationale / Risk                                     | Acceptance (G-W-T)                                                                                                                                                                                                         | Evidence (test/log/scan/policy)                                                                                  | Trace (issue/link) | Owner                    | Status   | Priority    | Severity      | Tags                      |
| ------- | -------------------------------------------- | ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- | ------------------ | ------------------------ | -------- | ----------- | ------------- | ------------------------- |
| NFR-001 | US-005 - Upload avatar                       | Security-InputValidation      | Reject payloads >1 MiB; allowlist MIME: `image/jpeg`, `image/png`; **extra fields forbidden**                                                                       | Защита от DoS, вредоносных загрузок и грязных данных | **Given** request body 2 MiB and contains unexpected fields<br>**When** POST `/api/files/avatar`<br>**Then** HTTP 413 Payload Too Large with `application/problem+json`; unknown fields → 400                              | e2e test `e2e-upload-limit`; schema validator; example response saved in `EVIDENCE/s03/upload-response.json`     | #S03-001           | Чикин С.А.               | Draft    | P2 - Medium | S2 - Major    | validation,uploads,limits |
| NFR-002 | US-004 - Edit profile                        | Security-AuthN                | All **write** endpoints require valid JWT (Authorization: Bearer). Expired/invalid → 401 with RFC7807 body and correlation_id                                       | Базовая аутентификация/защита изменения данных       | **Given** expired JWT<br>**When** POST `/api/profile`<br>**Then** HTTP 401 + `application/problem+json`; body contains `type/title/status/detail` and `correlation_id`                                                     | integration test `authn-write-required`; example 401 response in `EVIDENCE/s03/401-example.json`                 | #S03-002           | Чикин С.А.               | Draft    | P1 - High   | S1 - Critical | authn,security            |
| NFR-003 | US-002 - Login (brute-force)                 | RateLimiting                  | `/api/auth/login`: max **5** attempts / minute per IP **and** per account; exceed → 429 + `Retry-After` header                                                      | Защита от перебора паролей / credential stuffing     | **Given** active IP and account<br>**When** >5 failed login attempts within 60 seconds to `/api/auth/login`<br>**Then** subsequent requests return 429 and `Retry-After` with seconds                                      | brute-force simulation test; logs with 429 entries; `EVIDENCE/s03/rate-limit-log.txt`                            | #S03-003           | Чикин С.А.               | Proposed | P1 - High   | S1 - Critical | ratelimit,auth            |
| NFR-004 | US-006 - Просмотр списка (items)             | Performance                   | P95 latency for `GET /api/items?limit=50` ≤ **300 ms** at **50 RPS** sustained for **5 minutes**                                                                    | UX / SLO                                             | **Given** сервис здоров<br>**When** 50 RPS на `/api/items?limit=50` в течение 5 минут<br>**Then** P95 ≤ 300 ms и error rate ≤ 1%                                                                                           | нагрузочный отчёт `EVIDENCE/s03/load-50rps.html`; метрики `http_server_requests_seconds` квантиль                | #S03-004           | Чикин С.А                | Draft    | P2 - Medium | S2 - Major    | perf,slo,loadtest         |
| NFR-005 | US-018 - Интеграция с внешним API (vendor-x) | Timeouts/Retry/CircuitBreaker | Исходящие вызовы к `vendor-x`: timeout ≤ **2s**, retry ≤ **3** (с джиттером), circuit-breaker включается при ≥50% ошибок за 1 минуту                                | Устойчивость к падениям внешних сервисов             | **Given** недоступность `vendor-x`<br>**When** сервис вызывает `/api/integrations/vendor-x/*`<br>**Then** суммарное ожидание ≤ 6s; не более 3 retry; после порога — circuit breaker state=OPEN и ошибки сразу возвращаются | клиентский конфиг; интеграционные тесты отказа; лог breaker в `EVIDENCE/s03/breaker.log`                         | #S03-005           | Чикин С.А                | Proposed | P2 - Medium | S2 - Major    | resilience,timeoouts      |
| NFR-006 | US-011 - Роли и права / tenant isolation     | Security-AuthZ/RBAC           | Пользователь из `tenant=A` не может читать/менять ресурсы `tenant=B`; роль `viewer` не может выполнять `manager` действия                                           | Изоляция данных, принцип наименьших привилегий       | **Given** пользователь с ролью `viewer` из tenant A<br>**When** он запрашивает `GET /api/org/resources/{id}` для ресурса tenant B<br>**Then** HTTP 404 (или 403 по политике) без утечки данных в теле/заголовках           | тесты изоляции (unit/e2e); policy описание; proof: запрос/response saved in `EVIDENCE/s03/tenant-isolation.json` | #S03-006           | Чикин С.А                | Proposed | P1 - High   | S1 - Critical | authz,tenant,rbac         |
| NFR-007 | US-002 / US-004 - Observability & Logging    | Observability/Logging         | Все запросы логируются в **JSON** и содержат `correlation_id` (берётся из `X-Correlation-ID` или генерится). Логи содержат `method`, `path`, `status`, `latency_ms` | Трассировка запросов, расследование инцидентов       | **Given** запрос с заголовком `X-Correlation-ID=abc123`<br>**When** он проходит через сервис<br>**Then** во всех записях логов для этого запроса присутствует `correlation_id=abc123` и поля method/path/status/latency_ms | пример логов в `EVIDENCE/s03/logs-correlation-abc123.txt`; grep-запрос                                           | #S03-007           | Чикин С.А                | Draft    | P2 - Medium | S3 - Minor    | logging,observability     |
| NFR-008 | US-010 / infra                               | Security-Secrets              | В репозитории и его истории **0** секретов; runtime читает секреты только из env/KMS/secret-manager                                                                 | Предотвращение утечек ключей и creds                 | **Given** репозиторий и его история<br>**When** запускается скан секретов (gitleaks/gitleaks-action)<br>**Then** findings = 0; runtime-config использует env/KMS                                                           | gitleaks/gitleaks-action report `EVIDENCE/s03/gitleaks-report.json`; фрагмент конфигурации секретного доступа    | #S03-008           | Чикин С.А                | Proposed | P1 - High   | S1 - Critical | secrets,compliance        |
| NFR-009 | US-004 - Edit profile / Privacy              | Privacy/PII                   | Сырые PII не хранятся дольше **90** дней; PII маскируется в логах (email -> e****@domain)                                                                           | Конфиденциальность и регламенты хранения             | **Given** DTO с email/phone<br>**When** данные логируются или сохраняются<br>**Then** лог содержит замаскированные поля; в БД есть метка TTL ≤ 90 дней; политика ретенции применяется                                      | policy `EVIDENCE/s03/retention.md`; пример маскированного лога `EVIDENCE/s03/log-mask.txt`                       | #S03-009           | Чикин С.А                | Draft    | P1 - High   | S2 - Major    | privacy,pii,retention     |
